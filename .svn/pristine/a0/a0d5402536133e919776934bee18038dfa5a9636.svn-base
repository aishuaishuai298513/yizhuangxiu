//
//  My_pocket_CardAdd_ViewController.m
//  zhaiyi
//
//  Created by mac on 15/12/5.
//  Copyright © 2015年 apple. All rights reserved.
//

#import "My_pocket_CardAdd_ViewController.h"


#define NUMBERS @"0123456789\n"
@interface My_pocket_CardAdd_ViewController ()
<
UIPickerViewDataSource,
UIPickerViewDelegate,
UITextFieldDelegate
>
{
    UIPickerView *_pickerView;
    
    UIButton *_bankBtn;
    UITextField *_bankNumTF;
    NSArray *_bankArr;
    NSMutableDictionary *params;
    
    ADAccount *_account;

}
@end

@implementation My_pocket_CardAdd_ViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    [self setExtraCellLineHidden:self.tableView];

    [self initalData];
}



-(void)viewWillAppear:(BOOL)animated{
    [super viewWillAppear:animated];
    
    _account = [ADAccountTool account];
}

- (void)setExtraCellLineHidden: (UITableView *)tableView{
    
    UIView *view =[ [UIView alloc]init];
    
    view.backgroundColor = [UIColor clearColor];
    
    [tableView setTableFooterView:view];
    
    [tableView setTableHeaderView:view];
    
    
    
}
- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

#pragma mark - Table view data source

- (NSInteger)numberOfSectionsInTableView:(UITableView *)tableView {
     return 1;
}

- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section {
     return 3;
}


- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath {
    NSString * cellID;
    if (indexPath.row==0) {
        cellID=@"cell0";
    }else if (indexPath.row==1)
    {
        cellID=@"cell1";
    }
    else
    {
        cellID=@"cell2";
    }
    
    UITableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:cellID forIndexPath:indexPath];
    
    UILabel *label = [cell viewWithTag:420];
    if ([_account.type isEqualToString:@"78"]) {
        label.text = _account.username;
    } else {
        label.text = _account.em_name;
    }
    return cell;
}

-(void)initalData{
    self.title = @"添加银行卡";
    UIBarButtonItem *rightItem = [[UIBarButtonItem alloc] initWithTitle:@"完成" style:UIBarButtonItemStylePlain target:self action:@selector(clickFinish)];
    self.navigationItem.rightBarButtonItem = rightItem;
    params = [NSMutableDictionary dictionary];
    _pickerView = [[UIPickerView alloc]initWithFrame:CGRectMake(0, Ga/2, kU, Ga/2)];
    // 显示选中框
    _pickerView.showsSelectionIndicator=YES;
    _pickerView.dataSource = self;
    _pickerView.delegate = self;
    [self.view addSubview:_pickerView];
    _pickerView.hidden = YES;
    _bankArr=@[@"农业银行",@"中国银行",@"交通银行"];
    [_bankBtn setTitle:_bankArr[0] forState:UIControlStateNormal];
    [self resignTheFirstResponser];
}

- (IBAction)YHPicker:(id)sender {
    _bankBtn = (UIButton *)sender;
    _bankBtn.selected = !_bankBtn.selected;
    if (_bankBtn.selected) {
        _pickerView.hidden = NO;
    } else {
        _pickerView.hidden = YES;
    }
}

- (IBAction)bankNumTF:(UITextField *)sender {
    NSLog(@"sender %@",sender.text);
    _bankNumTF = sender;
    _bankNumTF.delegate = self;
    if (sender.text.length == 19||sender.text.length == 16) {
        NSLog(@"银行卡 %@",sender.text);
        [params setObject:sender.text forKey:@"bank_number"];
    } else {
        
    }
    
}
#pragma mark
-(BOOL)textField:(UITextField *)textField shouldChangeCharactersInRange:(NSRange)range replacementString:(NSString *)string{
//限制输入的内容
    NSCharacterSet *cs;
    cs = [[NSCharacterSet characterSetWithCharactersInString:NUMBERS]invertedSet];
    NSString *filtered = [[string componentsSeparatedByCharactersInSet:cs]componentsJoinedByString:@""];
    BOOL canChange = [string isEqualToString:filtered];
    return canChange;
}



// pickerView 列数
- (NSInteger)numberOfComponentsInPickerView:(UIPickerView *)pickerView {
    return 1;
}

// pickerView 每列个数
- (NSInteger)pickerView:(UIPickerView *)pickerView numberOfRowsInComponent:(NSInteger)component {
    return 3;
}
// 返回选中的行
- (void)pickerView:(UIPickerView *)pickerView didSelectRow:(NSInteger)row inComponent:(NSInteger)component
{
    
    [_bankBtn setTitle:_bankArr[row] forState:UIControlStateNormal];
}
//返回当前行的内容,此处是将数组中数值添加到滚动的那个显示栏上
-(NSString*)pickerView:(UIPickerView *)pickerView titleForRow:(NSInteger)row forComponent:(NSInteger)component
{
    return _bankArr[row];
}
-(UIView *)pickerView:(UIPickerView *)pickerView viewForRow:(NSInteger)row forComponent:(NSInteger)component reusingView:(UIView *)view{
    
    UILabel *label = (UILabel *)view;
    if (!label) {
        label = [[UILabel alloc]init];
        label.font = [UIFont systemFontOfSize:18];
        label.textAlignment = NSTextAlignmentCenter;
        label.backgroundColor = [UIColor clearColor];
    }
    label.text = [self pickerView:_pickerView titleForRow:row forComponent:component];
    return label;
}
#pragma mark 添加完成

-(void)clickFinish{
    NSLog(@"btn标题 %@",_bankBtn.titleLabel.text);
    if (_bankNumTF.text.length ==19||_bankNumTF.text.length == 16 ) {
        [self postData];

    } else {
        NSLog(@"kakakaa %ld",_bankNumTF.text.length);

        [ITTPromptView showMessage:@"您输入的银行卡号有误"];
    }
}
//请求数据
-(void)postData{
    
    [params setObject:_account.userid forKey:@"user_id"];
    [params setObject:_account.username forKey:@"username"];
    if (_bankBtn.titleLabel.text == nil) {
        [params setObject:_bankArr[0] forKey:@"bank_name"];
    }else {
    [params setObject:_bankBtn.titleLabel.text forKey:@"bank_name"];
    }
    [params setObject:_account.type forKey:@"type"];

    NSLog(@"添加银行卡 请求数据%@",params);
    [NetWork postNoParm:POST_ADD_BANKCARD params:params success:^(id responseObj) {
       
        if ([[responseObj objectForKey:@"code"]isEqualToString:@"1000"]) {
            [self.navigationController popViewControllerAnimated:YES];
        }
        [ITTPromptView showMessage:responseObj[@"message"]];
         NSLog(@"添加银行卡: %@",responseObj);
     } failure:^(NSError *error) {
        
    }];
}


-(void)resignTheFirstResponser{
    
    UITapGestureRecognizer *tap = [[UITapGestureRecognizer alloc]initWithTarget:self action:@selector(cancelTap:)];
    
    [self.view addGestureRecognizer:tap];
}
-(void)cancelTap:(UITapGestureRecognizer *)sender{
    [self.view endEditing:YES];
    _pickerView.hidden = YES;
}



@end
