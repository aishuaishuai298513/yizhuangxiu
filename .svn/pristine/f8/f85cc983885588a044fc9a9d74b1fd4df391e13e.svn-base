//
//  PersonalGuZhuController.m
//  zhaiyi
//
//  Created by cajan on 16/1/15.
//  Copyright © 2016年 apple. All rights reserved.
//

#import "PersonalGuZhuController.h"
#import "PersonaldetailsCell.h"
#import "Function.h"

#define CELL_ID @"Personal_cell_ID"
@interface PersonalGuZhuController ()
<
UITableViewDelegate,
UITableViewDataSource,
UIPickerViewDelegate,
UIPickerViewDataSource,
UITextFieldDelegate
>
{
    NSArray *_titleArr;
    NSArray *_contentArr;
    ADAccount *_account;
    
    UIView *_pView;
    UIPickerView *_pickerView;
    
    NSArray *_pickerContentArr;
    
    //上传的字典
    NSMutableDictionary *_params;
    //要保存的字典
    NSMutableDictionary *_modifyDict;
}
@end

@implementation PersonalGuZhuController

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view from its nib.
//    [self initalData];
    [self createUI];
}
-(void)viewWillAppear:(BOOL)animated{
    [super viewWillAppear:animated];
    [self initalData];
}
- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}
-(void)initalData{
    _account = [ADAccountTool account];
    _params = [NSMutableDictionary dictionary];
    _modifyDict = [NSMutableDictionary dictionary];
    _titleArr = @[@"姓名",@"性别",@"联系电话",@"联系地址"];
    _contentArr = @[_account.em_name,[self returnSexType:_account.em_sex],_account.tel,_account.address];
    _pickerContentArr = @[@"男",@"女"];
//    [self resignTheFirstResponser];
    [self setData];
}
//设置初始化数据
-(void)setData{
    [_params setObject:_account.userid forKey:@"user_id"];
    [_params setObject:_account.em_name forKey:@"username"];
    [_params setObject:_account.em_sex forKey:@"sex"];
    [_params setObject:_account.tel forKey:@"tel"];
    [_params setObject:_account.address forKey:@"address"];
    
    _modifyDict =  [ADAccountTool backWitDictionary];

}
-(void)createUI{
    [self customPickerView];
    //
    UIButton *rightButton = [UIButton buttonWithType:UIButtonTypeCustom];
    [rightButton setBackgroundImage:[UIImage imageNamed:@"右上角按钮"] forState:UIControlStateNormal];
    [rightButton setTitle:@"完成" forState:UIControlStateNormal];
    [rightButton setTitleColor:[UIColor blackColor] forState:UIControlStateNormal];
    rightButton.titleLabel.font = [UIFont systemFontOfSize:15];
    [rightButton addTarget:self action:@selector(clickFinish) forControlEvents:UIControlEventTouchUpInside];
    rightButton.frame = CGRectMake(0, 0, 84, 30);
    UIBarButtonItem *rightItem = [[UIBarButtonItem alloc]initWithCustomView:rightButton];
    self.navigationItem.rightBarButtonItem = rightItem;
    //
    self.tv.delegate = self;
    self.tv.dataSource = self;
    [self.tv setRowHeight:60];
    UIView *footerView = [UIView new];
    [self.tv setTableFooterView:footerView];
}
#pragma mark UITableView
-(NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section{
    return _titleArr.count;
}
//  textfield 的tag值 从380 - 383
-(UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
    
    PersonaldetailsCell *cell = [tableView dequeueReusableCellWithIdentifier:CELL_ID];
    if (!cell) {
        cell = [PersonaldetailsCell loadPersonaldetailsCell];
    }
    cell.nameLabel.text = _titleArr[indexPath.row];
    cell.textfield.text = _contentArr[indexPath.row];
    
    if (indexPath.row == 1) {
        cell.textfield.clearButtonMode = UITextFieldViewModeNever;
        cell.textfield.enabled = NO;
    }
    if (indexPath.row == 2) {
        cell.textfield.keyboardType = UIKeyboardTypeNumberPad;
    }
    cell.textfield.tag = 380 + indexPath.row;
    cell.textfield.delegate = self;
    
    return cell;
}

-(void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath{
    if (indexPath.row == 1) {
        NSLog(@"性别选择");
        _pView.hidden = NO;
    }
}


-(BOOL)textFieldShouldEndEditing:(UITextField *)textField{
    UIView *v = [textField superview];
    PersonaldetailsCell *cell = (PersonaldetailsCell *)[v superview];
    NSIndexPath *indexPath = [self.tv indexPathForCell:cell];
    _contentArr = @[_account.em_name,[self returnSexType:_account.em_sex],_account.tel,_account.address];

    switch (indexPath.row) {
        case 0:{
            [_params setObject:textField.text forKey:@"username"];
            [_modifyDict setObject:textField.text forKey:@"em_name"];
        }
            break;
        case 1:{

        }
            break;
        case 2:{
//            if ([Function isMobileNumber:textField.text]) {
                [_params setObject:textField.text forKey:@"tel"];
                [_modifyDict setObject:textField.text forKey:@"tel"];
//            }
            
            
            
        }
            break;
        case 3:{
            [_params setObject:textField.text forKey:@"address"];
            [_modifyDict setObject:textField.text forKey:@"address"];
            
        }
            break;
          
        default:
            break;
    }
    return YES;
}



#pragma mark 判断性别
-(NSString *)getSexType:(NSString *)str{
    if ([str isEqualToString:@"男"]) {
        return @"82";
    }else{
        return @"81";
    }
}
-(NSString *)returnSexType:(NSString *)str{
    if ([str isEqualToString:@"82"]) {
        return @"男";
    }else{
        return @"女";
    }
}


#pragma mark 自定义 pickerView
-(UIView *)customPickerView{
    
    _pView = [[UIView alloc]initWithFrame:CGRectMake(0, Ga-240, kU, 240)];
    _pickerView = [[UIPickerView alloc]initWithFrame:CGRectMake(0, 40, kU, 200)];
    UIButton *leftBtn = [UIButton buttonWithType:UIButtonTypeCustom];
    leftBtn.frame = CGRectMake(10, 0, 60, 30);
    [leftBtn setTitle:@"取消" forState:UIControlStateNormal];
    leftBtn.titleLabel.font = [UIFont systemFontOfSize:17];
    [leftBtn setTitleColor:BLUE_COLOR forState:UIControlStateNormal];
    [leftBtn addTarget:self action:@selector(cancelChoosePicker) forControlEvents:UIControlEventTouchUpInside];
    [_pView addSubview:leftBtn];
    
    UIButton *rightBtn = [UIButton buttonWithType:UIButtonTypeCustom];
    rightBtn.frame = CGRectMake(kU - 70, 0, 60, 30);
    [rightBtn setTitle:@"确定" forState:UIControlStateNormal];
    rightBtn.titleLabel.font = [UIFont systemFontOfSize:17];
    [rightBtn setTitleColor:BLUE_COLOR forState:UIControlStateNormal];
    [rightBtn addTarget:self action:@selector(ensureChoosePicker) forControlEvents:UIControlEventTouchUpInside];
    [_pView addSubview:rightBtn];
    
    _pView.backgroundColor = [UIColor colorWithRed:240/255.0 green:240/255.0 blue:240/255.0 alpha:1.0];
    _pickerView.backgroundColor = [UIColor whiteColor];
    _pickerView.delegate = self;
    _pickerView.dataSource =self;
    [_pView addSubview:_pickerView];
    [self.view addSubview:_pView];
    _pView.hidden = YES;
    
    return _pView;
}
//
-(void)cancelChoosePicker{
    [UIView animateWithDuration:2 animations:^{
        _pView.hidden = YES;
        [self.view layoutIfNeeded];
        
    }];
    
    NSLog(@"取消");
}
-(void)ensureChoosePicker{
    
 
    
    [UIView animateWithDuration:1 animations:^{
        _pView.hidden = YES;
    }];
}

#pragma mark PickerView
-(NSInteger)pickerView:(UIPickerView *)pickerView numberOfRowsInComponent:(NSInteger)component{
    return _pickerContentArr.count;
}
-(NSString *)pickerView:(UIPickerView *)pickerView titleForRow:(NSInteger)row forComponent:(NSInteger)component{
    return _pickerContentArr[row];
    
}
-(NSInteger)numberOfComponentsInPickerView:(UIPickerView *)pickerView{
    return 1;
}
-(void)pickerView:(UIPickerView *)pickerView didSelectRow:(NSInteger)row inComponent:(NSInteger)component{
    
    NSInteger selectIndex = [pickerView selectedRowInComponent:0];
    UITextField *textFeild = (UITextField *)[self.tv viewWithTag:381];
    textFeild.text = _pickerContentArr [selectIndex];
//    [_modifyDict setObject:textFeild.text forKey:@"em_sex"];
    NSLog(@"select %@", _pickerContentArr [selectIndex]);
    
}
-(UIView *)pickerView:(UIPickerView *)pickerView viewForRow:(NSInteger)row forComponent:(NSInteger)component reusingView:(UIView *)view{
    
    UILabel* pickerLabel = (UILabel*)view;
    if (!pickerLabel){
        pickerLabel = [[UILabel alloc] init];
        //        pickerLabel.minimumScaleFactor = 8.0;
        pickerLabel.adjustsFontSizeToFitWidth = YES;
        [pickerLabel setTextAlignment:NSTextAlignmentCenter];
        [pickerLabel setBackgroundColor:[UIColor clearColor]];
        [pickerLabel setFont:[UIFont systemFontOfSize:18]];
    }
    pickerLabel.text=[self pickerView:pickerView titleForRow:row forComponent:component];
    return pickerLabel;
}

//完成修改
-(void)clickFinish{

    
    [self getTextFieldText];
    NSLog(@"个人信息待上传信息: %@",_params);
    NSLog(@"个人信息待保存信息: %@",_modifyDict);
    
    if ([Function isMobileNumber:[_params objectForKey:@"tel"]]) {
        [self postData];
    }
    NSLog(@"%@",[_params objectForKey:@"tel"]);
    NSLog(@"完成修改");
    
}
//获取 textField 上文字
-(void)getTextFieldText{
    //姓名
    UITextField *nameTF = [self.view viewWithTag:380];
    [_params setObject:nameTF.text forKey:@"username"];
    [_modifyDict setObject:nameTF.text forKey:@"em_name"];
    //性别
    UITextField *sexTF = [self.view viewWithTag:381];
    [_params setObject:[self getSexType:sexTF.text] forKey:@"sex"];
    [_modifyDict setObject: [self getSexType:sexTF.text] forKey:@"em_sex"];
    //电话
    UITextField *telTF = [self.view viewWithTag:382];
    [_params setObject:telTF.text forKey:@"tel"];
    [_modifyDict setObject:telTF.text forKey:@"tel"];
    //地址
    UITextField *addressTF = [self.view viewWithTag:383];
    [_params setObject:addressTF.text forKey:@"address"];
    [_modifyDict setObject:addressTF.text forKey:@"address"];

}


#pragma mark 上传数据
-(void)postData{

    [NetWork postNoParm:POST_GUZHU_DETAIL_URL params:_params success:^(id responseObj) {
        
        [ITTPromptView showMessage:responseObj[@"message"]];
        NSLog(@"个人信息:%@",responseObj);
        if ([[responseObj objectForKey:@"code"]isEqualToString:@"1000"]) {
            //成功后数据保存到本地
            _account = [ADAccount accountWithDict:_modifyDict];
            [ADAccountTool save:_account];
            [self.navigationController popViewControllerAnimated:YES];
        }
        
    } failure:^(NSError *error) {
         NSLog(@"个人信息:%@",error.localizedDescription);
         [ITTPromptView showMessage:@"上传失败"];
    }];
}

-(void)resignTheFirstResponser{
    UITapGestureRecognizer *tapFirst = [[UITapGestureRecognizer alloc]initWithTarget:self action:@selector(resignTheFirst:)];
    [self.view addGestureRecognizer:tapFirst];
}
-(void)resignTheFirst:(UITapGestureRecognizer *)sender{
    [self.view endEditing:YES];
}

@end
