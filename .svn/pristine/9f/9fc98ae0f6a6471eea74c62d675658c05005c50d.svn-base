//
//  My_pocket_tixian_ShareController.m
//  zhaiyi
//
//  Created by sks on 15/12/5.
//  Copyright © 2015年 apple. All rights reserved.
//

#import "My_pocket_tixian_ShareController.h"


#define GET_RECORD @"http://zhaiyi.bjqttd.com/api/personal/share_with"
@interface My_pocket_tixian_ShareController ()
{
    NSString *isFirstShare;
}
@end

@implementation My_pocket_tixian_ShareController

- (void)viewDidLoad {
    [super viewDidLoad];
    self.view.backgroundColor = [UIColor whiteColor];
    
    [self creatView];
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/
//创建分享视图
-(void)creatView{
    
    UIView *bgView = [[UIView alloc]initWithFrame:CGRectMake(50,Ga/2-(kU-100)/2, kU-100, kU-100)];
    bgView.layer.cornerRadius = 3;
    bgView.layer.borderWidth = 1;
    bgView.layer.borderColor = [UIColor grayColor].CGColor;
    [self.view addSubview:bgView];
    CGFloat bgWidth = bgView.size.width;
    CGFloat bgHighte = bgView.size.height;

    UIButton *qqShareBtn = [UIButton buttonWithType:UIButtonTypeCustom];
    UIButton *wxShareBtn = [UIButton buttonWithType:UIButtonTypeCustom];
    qqShareBtn.frame = CGRectMake(bgWidth/2-80, bgHighte/2+20, 40, 40);
    wxShareBtn.frame = CGRectMake(bgWidth/2+40, bgHighte/2+20, 40, 40);
    [qqShareBtn setImage:[UIImage imageNamed:@"qq"] forState:UIControlStateNormal];
    [wxShareBtn setImage:[UIImage imageNamed:@"weixin"] forState:UIControlStateNormal];
    [qqShareBtn addTarget:self action:@selector(qqShare:) forControlEvents:UIControlEventTouchUpInside];
    [wxShareBtn addTarget:self action:@selector(wxShare:) forControlEvents:UIControlEventTouchUpInside];

    [bgView addSubview:qqShareBtn];
    [bgView addSubview:wxShareBtn];
    
    UILabel *titleLb = [[UILabel alloc]initWithFrame:CGRectMake((bgWidth-200)/2, bgHighte/2-40,200, 20)];
    titleLb.text = @"分享即赠送50积分";
    titleLb.textAlignment = NSTextAlignmentCenter;
    [bgView addSubview:titleLb];
    
}
-(void)qqShare:(UIButton *)sender{
    
    [[UMSocialDataService defaultDataService]postSNSWithTypes:@[UMShareToQQ] content:@"分享内容文字" image:nil location:nil urlResource:nil presentedController:self completion:^(UMSocialResponseEntity *response) {
        if (response.responseCode == UMSResponseCodeSuccess) {
            NSLog(@"分享成功");
            
            [self judgeIsShared];
            
        }
    }];
}
-(void)wxShare:(UIButton *)sender{
    
    [[UMSocialDataService defaultDataService]postSNSWithTypes:@[UMShareToWechatSession] content:@"分享内容文字" image:nil location:nil urlResource:nil presentedController:self completion:^(UMSocialResponseEntity *response) {
        if (response.responseCode == UMSResponseCodeSuccess) {
            NSLog(@"分享成功");
            
            [self judgeIsShared];
        }
    }];
}

-(void)judgeIsShared{
    
    NSUserDefaults *user = [NSUserDefaults standardUserDefaults];
    if ([[self getDate] isEqualToString:[user objectForKey:@"Is_Fist_Share"]]) {
        NSLog(@"分享过了,不再增加积分");
    } else {
        [self postRecord];
    }
    
}


-(void)postRecord{
    ADAccount *acount = [ADAccountTool account];
    NSMutableDictionary *params = [NSMutableDictionary dictionary];
    [params setObject:acount.userid forKey:@"user_id"];
    NSInteger  recordNum = [acount.record integerValue] + 50;
    NSString *record = [NSString stringWithFormat:@"%ld",recordNum];
    [params setObject:record forKey:@"record"];
    
    [NetWork postNoParm:GET_RECORD params:params success:^(id responseObj) {
        NSLog(@"分享上传: %@",responseObj);
        if ([[responseObj objectForKey:@"code"]isEqualToString:@"1000"]) {
            NSUserDefaults *user = [NSUserDefaults standardUserDefaults];
            [user setObject:[self getDate] forKey:@"Is_Fist_Share"];
            [user synchronize];
        }
    } failure:^(NSError *error) {
        NSLog(@"分享上传失败 :%@",error.localizedDescription);
    }];
    
    
    
    
}

-(NSString *)getDate{
    NSDate *now = [NSDate date];
    NSCalendar *calendar = [NSCalendar currentCalendar];
    NSUInteger unitFlags = NSCalendarUnitYear|NSCalendarUnitMonth|NSCalendarUnitDay;
    NSDateComponents *dateComponent = [calendar components:unitFlags fromDate:now];
    
    NSInteger year = [dateComponent year];
    NSInteger month = [dateComponent month];
    NSInteger day = [dateComponent day];
    
    NSString *dateString = [NSString stringWithFormat:@"%ld%ld%ld",year,month,day];
    NSLog(@"日期%@",dateString);
    
    return dateString;
    
}


@end
