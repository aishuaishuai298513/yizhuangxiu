//
//  My_pocket_CardAdd_ViewController.m
//  zhaiyi
//
//  Created by mac on 15/12/5.
//  Copyright © 2015年 apple. All rights reserved.
//

#import "My_pocket_CardAdd_ViewController.h"


#define NUMBERS @"0123456789\n"
@interface My_pocket_CardAdd_ViewController ()
<
UIPickerViewDataSource,
UIPickerViewDelegate,
UITextFieldDelegate
>
{
    UIPickerView *_pickerView;
    
    UIButton *_bankBtn;
    UITextField *_bankNumTF;
    NSArray *_bankArr;
    NSMutableDictionary *params;
    
    ADAccount *_account;
}
@end

@implementation My_pocket_CardAdd_ViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    [self setExtraCellLineHidden:self.tableView];
    _account = [ADAccountTool account];

    [self initalData];
}



-(void)viewWillAppear:(BOOL)animated{
    [super viewWillAppear:animated];
    
    _account = [ADAccountTool account];
    
    NSLog(@"username %@",_account.username);
}

- (void)setExtraCellLineHidden: (UITableView *)tableView{
    
    UIView *view =[ [UIView alloc]init];
    
    view.backgroundColor = [UIColor clearColor];
    
    [tableView setTableFooterView:view];
    
    [tableView setTableHeaderView:[self creatHeaderView]];
    
    
    
}
- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

#pragma mark - Table view data source

- (NSInteger)numberOfSectionsInTableView:(UITableView *)tableView {
     return 1;
}

- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section {
     return 3;
}


- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath {
    NSString * cellID;
    if (indexPath.row==0) {
        cellID=@"cell0";
    }else if (indexPath.row==1)
    {
        cellID=@"cell1";
    }
    else
    {
        cellID=@"cell2";
    }
    
    UITableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:cellID forIndexPath:indexPath];
    
    UILabel *label = [cell viewWithTag:420];
    if ([_account.type isEqualToString:@"78"]) {
        label.text = _account.username;
        [params setObject:_account.username forKey:@"username"];
    } else {
        label.text = _account.em_name;
        [params setObject:_account.em_name forKey:@"username"];
    }
    return cell;
}

-(void)initalData{
    self.title = @"添加银行卡";
    
    UIButton *rightButton = [UIButton buttonWithType:UIButtonTypeCustom];
    [rightButton setBackgroundImage:[UIImage imageNamed:@"右上角按钮"] forState:UIControlStateNormal];
    [rightButton setTitle:@"完成" forState:UIControlStateNormal];
    [rightButton setTitleColor:[UIColor blackColor] forState:UIControlStateNormal];
    rightButton.titleLabel.font = [UIFont systemFontOfSize:15];
    [rightButton addTarget:self action:@selector(clickFinish) forControlEvents:UIControlEventTouchUpInside];
    rightButton.frame = CGRectMake(0, 0, 84, 30);
    UIBarButtonItem *rightItem = [[UIBarButtonItem alloc]initWithCustomView:rightButton];
    self.navigationItem.rightBarButtonItem = rightItem;
    
    params = [NSMutableDictionary dictionary];
    _pickerView = [[UIPickerView alloc]initWithFrame:CGRectMake(0, Ga/2, kU, Ga/2)];
    // 显示选中框
    _pickerView.showsSelectionIndicator=YES;
    _pickerView.dataSource = self;
    _pickerView.delegate = self;
    [self.view addSubview:_pickerView];
    _pickerView.hidden = YES;
    _bankArr=@[@"农业银行",@"中国银行",@"交通银行",@"工商银行",@"邮政储蓄银行"];
    [_bankBtn setTitle:_bankArr[0] forState:UIControlStateNormal];
    [self resignTheFirstResponser];
}

- (IBAction)YHPicker:(id)sender {
    _bankBtn = (UIButton *)sender;
    _bankBtn.selected = !_bankBtn.selected;
    if (_bankBtn.selected) {
        _pickerView.hidden = NO;
    } else {
        _pickerView.hidden = YES;
    }
}

- (IBAction)bankNumTF:(UITextField *)sender {
    NSLog(@"sender %@",sender.text);
    _bankNumTF = sender;
    _bankNumTF.delegate = self;
    if (sender.text.length == 19||sender.text.length == 16) {
        NSLog(@"银行卡 %@",sender.text);
        [params setObject:sender.text forKey:@"bank_number"];
    } else {
        
    }
    
}
#pragma mark
-(BOOL)textField:(UITextField *)textField shouldChangeCharactersInRange:(NSRange)range replacementString:(NSString *)string{
//限制输入的内容
    NSCharacterSet *cs;
    cs = [[NSCharacterSet characterSetWithCharactersInString:NUMBERS]invertedSet];
    NSString *filtered = [[string componentsSeparatedByCharactersInSet:cs]componentsJoinedByString:@""];
    BOOL canChange = [string isEqualToString:filtered];
    return canChange;
}



// pickerView 列数
- (NSInteger)numberOfComponentsInPickerView:(UIPickerView *)pickerView {
    return 1;
}

// pickerView 每列个数
- (NSInteger)pickerView:(UIPickerView *)pickerView numberOfRowsInComponent:(NSInteger)component {
    return _bankArr.count;
}
// 返回选中的行
- (void)pickerView:(UIPickerView *)pickerView didSelectRow:(NSInteger)row inComponent:(NSInteger)component
{
    
    [_bankBtn setTitle:_bankArr[row] forState:UIControlStateNormal];
}
//返回当前行的内容,此处是将数组中数值添加到滚动的那个显示栏上
-(NSString*)pickerView:(UIPickerView *)pickerView titleForRow:(NSInteger)row forComponent:(NSInteger)component
{
    return _bankArr[row];
}
-(UIView *)pickerView:(UIPickerView *)pickerView viewForRow:(NSInteger)row forComponent:(NSInteger)component reusingView:(UIView *)view{
    
    UILabel *label = (UILabel *)view;
    if (!label) {
        label = [[UILabel alloc]init];
        label.font = [UIFont systemFontOfSize:18];
        label.textAlignment = NSTextAlignmentCenter;
        label.backgroundColor = [UIColor clearColor];
    }
    label.text = [self pickerView:_pickerView titleForRow:row forComponent:component];
    return label;
}
//headerView
-(UIView *)creatHeaderView{
    UIView *view = [[UIView alloc]initWithFrame:CGRectMake(0, 0, kU, 38)];
    view.backgroundColor = [UIColor colorWithRed:230/255.0 green:230/255.0 blue:230/255.0 alpha:1.0];
    UILabel *label = [[UILabel alloc]initWithFrame:CGRectMake(10, 9, kU-20, 20)];
    label.textColor = [UIColor colorWithRed:140/255.0 green:140/255.0 blue:140/255.0 alpha:1.0];
    label.font = [UIFont systemFontOfSize:15];
    label.text = @"请绑定持卡人本人的银行卡";
    [view addSubview:label];
    return view;
}



#pragma mark 添加完成

-(void)clickFinish{
    NSLog(@"btn标题 %@",_bankBtn.titleLabel.text);
    if (_bankNumTF.text.length ==19||_bankNumTF.text.length == 16 ) {
        [self postData];

    } else {
        NSLog(@"kakakaa %ld",_bankNumTF.text.length);

        [ITTPromptView showMessage:@"您输入的银行卡号有误"];
    }
}
//请求数据
-(void)postData{
    

    [params setObject:_account.userid forKey:@"user_id"];
    
    if (_bankBtn.titleLabel.text == nil) {
        [params setObject:_bankArr[0] forKey:@"bank_name"];
    }else {
    [params setObject:_bankBtn.titleLabel.text forKey:@"bank_name"];
    }
 
    NSLog(@"添加银行卡 请求数据%@",params);
    [NetWork postNoParm:POST_ADD_BANKCARD params:params success:^(id responseObj) {
       
        if ([[responseObj objectForKey:@"code"]isEqualToString:@"1000"]) {
            [self.navigationController popViewControllerAnimated:YES];
        }
        [ITTPromptView showMessage:responseObj[@"message"]];
         NSLog(@"添加银行卡: %@",responseObj);
     } failure:^(NSError *error) {
        
    }];
}


-(void)resignTheFirstResponser{
    
    UITapGestureRecognizer *tap = [[UITapGestureRecognizer alloc]initWithTarget:self action:@selector(cancelTap:)];
    
    [self.view addGestureRecognizer:tap];
}
-(void)cancelTap:(UITapGestureRecognizer *)sender{
    [self.view endEditing:YES];
    _pickerView.hidden = YES;
}



@end
